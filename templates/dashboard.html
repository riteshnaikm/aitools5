{% extends 'base.html' %}

{% block title %}Analytics Dashboard - HR Assistant{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> Analytics Dashboard</h2>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" data-days="7">7 Days</button>
            <button type="button" class="btn btn-outline-primary" data-days="30">30 Days</button>
            <button type="button" class="btn btn-outline-primary" data-days="90">90 Days</button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="dashboard-loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading analytics...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" style="display: none;">
        <!-- Key Metrics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card bg-primary bg-gradient text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Total Evaluations</h6>
                                <h2 class="mb-0" id="metric-total-evals">0</h2>
                            </div>
                            <i class="bi bi-file-earmark-text fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card bg-success bg-gradient text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Total Handbooks</h6>
                                <h2 class="mb-0" id="metric-total-handbooks">0</h2>
                            </div>
                            <i class="bi bi-book fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card bg-info bg-gradient text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Active Jobs</h6>
                                <h2 class="mb-0" id="metric-active-jobs">0</h2>
                                <small class="text-white-50">Last 7 days</small>
                            </div>
                            <i class="bi bi-briefcase fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card bg-warning bg-gradient text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Avg Match Score</h6>
                                <h2 class="mb-0"><span id="metric-avg-score">0</span>%</h2>
                            </div>
                            <i class="bi bi-star fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row of Metrics -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted mb-1">Total Jobs</h6>
                        <h3 class="mb-0" id="metric-total-jobs">0</h3>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted mb-1">Conversion Rate</h6>
                        <h3 class="mb-0"><span id="metric-conversion-rate">0</span>%</h3>
                        <small class="text-muted">Handbook â†’ Evals</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted mb-1">Avg Evals/Job</h6>
                        <h3 class="mb-0" id="metric-avg-evals-job">0</h3>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted mb-1">Avg Eval Time</h6>
                        <h3 class="mb-0"><span id="metric-avg-time">0</span>s</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Timeline Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> Activity Timeline</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="activityChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Jobs Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Jobs by Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Job ID</th>
                                        <th>Job Title</th>
                                        <th>Evaluations</th>
                                        <th>Avg Score</th>
                                        <th>Last Active</th>
                                    </tr>
                                </thead>
                                <tbody id="top-jobs-body">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let activityChart = null;
let currentDays = 7;

document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    
    // Date range buttons
    document.querySelectorAll('[data-days]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-days]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentDays = parseInt(this.getAttribute('data-days'));
            loadDashboard();
        });
    });
});

async function loadDashboard() {
    try {
        document.getElementById('dashboard-loading').style.display = 'block';
        document.getElementById('dashboard-content').style.display = 'none';
        
        // Load overview metrics
        const overviewResponse = await fetch('/api/analytics/overview');
        const overviewData = await overviewResponse.json();
        
        if (overviewData.success) {
            const metrics = overviewData.metrics;
            document.getElementById('metric-total-evals').textContent = metrics.total_evaluations;
            document.getElementById('metric-total-handbooks').textContent = metrics.total_handbooks;
            document.getElementById('metric-total-jobs').textContent = metrics.total_jobs;
            document.getElementById('metric-active-jobs').textContent = metrics.active_jobs;
            document.getElementById('metric-avg-score').textContent = metrics.avg_match_score;
            document.getElementById('metric-conversion-rate').textContent = metrics.conversion_rate;
            document.getElementById('metric-avg-evals-job').textContent = metrics.avg_evals_per_job;
            document.getElementById('metric-avg-time').textContent = metrics.avg_eval_time;
        }
        
        // Load timeline chart
        const timelineResponse = await fetch(`/api/analytics/timeline?days=${currentDays}`);
        const timelineData = await timelineResponse.json();
        
        if (timelineData.success) {
            renderActivityChart(timelineData.timeline);
        }
        
        // Load top jobs
        const jobsResponse = await fetch('/api/analytics/top-jobs?limit=10');
        const jobsData = await jobsResponse.json();
        
        if (jobsData.success) {
            renderTopJobs(jobsData.jobs);
        }
        
        document.getElementById('dashboard-loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard-loading').innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> Failed to load dashboard data. Please try again.
            </div>
        `;
    }
}

function renderActivityChart(timeline) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    const labels = timeline.map(t => t.date);
    const evaluations = timeline.map(t => t.evaluations);
    const handbooks = timeline.map(t => t.handbooks);
    
    if (activityChart) {
        activityChart.destroy();
    }
    
    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Evaluations',
                    data: evaluations,
                    borderColor: 'rgb(13, 110, 253)',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Handbooks',
                    data: handbooks,
                    borderColor: 'rgb(25, 135, 84)',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return new Date(context[0].label).toLocaleDateString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function renderTopJobs(jobs) {
    const tbody = document.getElementById('top-jobs-body');
    
    if (jobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = jobs.map((job, index) => `
        <tr>
            <td><strong>${index + 1}</strong></td>
            <td><span class="badge bg-primary">${job.job_id}</span></td>
            <td>${job.job_title || 'Untitled'}</td>
            <td><span class="badge bg-info">${job.eval_count}</span></td>
            <td><strong>${job.avg_score}%</strong></td>
            <td><small class="text-muted">${new Date(job.last_active).toLocaleString()}</small></td>
        </tr>
    `).join('');
}
</script>
{% endblock %}

